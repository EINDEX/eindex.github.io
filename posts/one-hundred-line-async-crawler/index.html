<!doctype html><html charset=utf-8 lang=en><head><link href=https://eindex.me/feed.xml rel=alternate title=RSS type=application/rss+xml><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0,maximum-scale=1" name=viewport><meta content=EINDEX itemprop=author name=author><title>一百行代码实现异步爬虫 • EINDEX's Blog</title><meta content="一百行代码实现异步爬虫 • EINDEX's Blog" property=og:title><meta charset=utf-8><link href="https://eindex.me/css/index.css?h=f8faf511a8be60c25ce46e10d43e25cc133e48203f3dc383262447b1abda9301" rel=stylesheet><style>@-moz-document url-prefix() {.lazy:-moz-loading {visibility:hidden;}}.ieOnly {display: none;}@media all and (-ms-high-contrast: none), (-ms-high-contrast: active) {.ieOnly {display: block;}}</style><link href="https://eindex.me/styles/fontawesome.min.css?h=7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f" rel=stylesheet><link href=https://webmention.io/eindex.me/webmention rel=webmention><link href=https://webmention.io/eindex.me/xmlrpc rel=pingback><link href=/favicon-512.png rel=apple-touch-icon sizes=512x512><link href=/favicon-512.png rel=icon sizes=512x512 type=image/png><link href=/favicon-192.png rel=icon sizes=192x192 type=image/png><link href=/manifest.json rel=manifest><meta content=https://eindex.me/posts/one-hundred-line-async-crawler/ property=og:url><meta content="EINDEX's Blog" property=og:site_name><meta content=https://eindex.me/images/avatar.png property=og:image><meta content=summary name=twitter:card><meta content="一百行代码实现异步爬虫 • EINDEX's Blog" name=twitter:title><meta content=@eindex_li name=twitter:site><meta content=@eindex_li name=twitter:creator><meta content=https://eindex.me/images/avatar.png name=twitter:image><script type=application/ld+json>
    {
      "@context": "https://schema.org/",
      "@type": "BlogPosting",
      "headline": "一百行代码实现异步爬虫",
      "image": "https://eindex.me/images/avatar.png",
      
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://eindex.me/posts/one-hundred-line-async-crawler/"
      },
      
      "datePublished": "2019-09-07",
      
      
      "author": {
        "@type": "Person",
        "name": "EINDEX",
        "url": "https://eindex.me/about"
      },
      "publisher": {
        "@type": "Organization",
        "name": "EINDEX's Blog",
        "logo": {
          "@type": "ImageObject",
          "url": "https://eindex.me/images/avatar.png"
      },
      "keywords": ["代码","Python","Crawler","Async"]
    }
</script><script>(function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "ao1gr1m9ku");</script><body><nav class=navbar><ul class=items><li><a class=site-link href=https://eindex.me><img alt=Workflow class=avatar src=https://eindex.me/processed_images/985d495e6e585ad000.png><span class=site-name>EINDEX's Blog</span></a><li class=delimiter><li class=button><a href=https://eindex.me/archive/>归档</a><li class=button><a href=https://eindex.me/links/>友链</a><li class=button><a href=https://eindex.me/about/>关于</a></ul></nav><div class=content><main><article data-clarity-region=article><section class=header><section class=title-area><h1 class=title><a href=https://eindex.me/posts/one-hundred-line-async-crawler/>一百行代码实现异步爬虫</a></h1></section><section class=meta-area><span><i class="far fa-calendar-days"></i><time>2019-09-07</time></span><a class=categories href=https://eindex.me/categories/dai-ma/><i class="fa-solid fa-inbox"></i>代码</a><span><i class="fas fa-clock"></i> 3 mins</span></section></section><section class=main><p>一个优雅的爬虫需要一下这些东西：<ul><li>请求器<li>页面解析器<li>链接生成器<li>调度器</ul><span id=continue-reading></span><h2 id=请求器>请求器</h2><p>负责发送请求。<h2 id=页面解析器>页面解析器</h2><p>负责从页面上解析出继续爬的链接。<h2 id=链接生成器>链接生成器</h2><p>负责处理继续爬虫的链接并放入队列。<h2 id=调度器>调度器</h2><p>决定链接是否应该被爬去的核心部件。<h2 id=异步>异步</h2><p>同时有多个请求在发送，即时异步爬虫。<h2 id=代码>代码</h2><p>相关代码已上传到 <a href=https://github.com/EINDEX/100-line-async-spider>Github[https://github.com/EINDEX/100-line-async-spider]</a>。<pre class=language-python data-lang=python style=background-color:#272822;color:#f8f8f2;><code class=language-python data-lang=python><span style=color:#f92672;>import </span><span>aiohttp, asyncio, aiofiles, lxml, pathlib, sys, re, lxml.html
</span><span style=color:#f92672;>from </span><span>urllib.parse </span><span style=color:#f92672;>import </span><span>urlparse
</span><span style=color:#f92672;>from </span><span>pathlib </span><span style=color:#f92672;>import </span><span>Path
</span><span style=color:#f92672;>from </span><span>hashlib </span><span style=color:#f92672;>import </span><span>md5
</span><span>
</span><span>MAX_GET, MAX_QUEUE_SIZE, MAX_WORKER </span><span style=color:#f92672;>= </span><span style=color:#ae81ff;>10000</span><span>, </span><span style=color:#ae81ff;>100</span><span>, </span><span style=color:#ae81ff;>20
</span><span>spider_url_set, spider_content_set </span><span style=color:#f92672;>= </span><span style=font-style:italic;color:#66d9ef;>set</span><span>(), </span><span style=font-style:italic;color:#66d9ef;>set</span><span>()
</span><span>status </span><span style=color:#f92672;>= </span><span>{</span><span style=color:#e6db74;>"success"</span><span>: </span><span style=color:#ae81ff;>0</span><span>, </span><span style=color:#e6db74;>"all"</span><span>: </span><span style=color:#ae81ff;>0</span><span>, </span><span style=color:#e6db74;>"same"</span><span>: </span><span style=color:#ae81ff;>0</span><span>, </span><span style=color:#e6db74;>"same_content"</span><span>:</span><span style=color:#ae81ff;>0</span><span>}
</span><span>
</span><span style=color:#f92672;>async </span><span style=font-style:italic;color:#f92672;>def </span><span style=color:#a6e22e;>fetch</span><span>(</span><span style=font-style:italic;color:#fd971f;>url</span><span>):
</span><span>    </span><span style=color:#f92672;>global </span><span>MAX_GET
</span><span>    </span><span style=color:#f92672;>if </span><span>MAX_GET </span><span style=color:#f92672;>< </span><span style=color:#ae81ff;>0</span><span>:
</span><span>        </span><span style=color:#f92672;>return
</span><span>    </span><span style=color:#f92672;>async with </span><span>aiohttp.ClientSession(</span><span style=font-style:italic;color:#fd971f;>connector</span><span style=color:#f92672;>=</span><span>aiohttp.TCPConnector(</span><span style=font-style:italic;color:#fd971f;>ssl</span><span style=color:#f92672;>=</span><span style=color:#ae81ff;>False</span><span>), </span><span style=font-style:italic;color:#fd971f;>timeout</span><span style=color:#f92672;>=</span><span>aiohttp.ClientTimeout(</span><span style=font-style:italic;color:#fd971f;>total</span><span style=color:#f92672;>=</span><span style=color:#ae81ff;>1</span><span>)) </span><span style=color:#f92672;>as </span><span>session:
</span><span>        </span><span style=color:#f92672;>async with </span><span>session.get(url) </span><span style=color:#f92672;>as </span><span>response:
</span><span>            </span><span style=color:#f92672;>return await </span><span>response.text()
</span><span>
</span><span style=color:#f92672;>async </span><span style=font-style:italic;color:#f92672;>def </span><span style=color:#a6e22e;>savefile</span><span>(</span><span style=font-style:italic;color:#fd971f;>path</span><span>, </span><span style=font-style:italic;color:#fd971f;>data</span><span>):
</span><span>    path </span><span style=color:#f92672;>= </span><span>Path(path)
</span><span>    path.parent.mkdir(</span><span style=font-style:italic;color:#fd971f;>parents</span><span style=color:#f92672;>=</span><span style=color:#ae81ff;>True</span><span>, </span><span style=font-style:italic;color:#fd971f;>exist_ok</span><span style=color:#f92672;>=</span><span style=color:#ae81ff;>True</span><span>)
</span><span>    </span><span style=color:#f92672;>async with </span><span>aiofiles.open(path, </span><span style=font-style:italic;color:#fd971f;>mode</span><span style=color:#f92672;>=</span><span style=color:#e6db74;>'w'</span><span>) </span><span style=color:#f92672;>as </span><span>f:
</span><span>        </span><span style=color:#f92672;>await </span><span>f.write(data)
</span><span>
</span><span style=font-style:italic;color:#f92672;>def </span><span style=color:#a6e22e;>data_analysis</span><span>(</span><span style=font-style:italic;color:#fd971f;>data</span><span>):
</span><span>    </span><span style=color:#f92672;>try</span><span>:
</span><span>        html </span><span style=color:#f92672;>= </span><span>lxml.html.fromstring(data)
</span><span>        </span><span style=color:#f92672;>return </span><span>html.xpath(</span><span style=color:#e6db74;>'//a/@href'</span><span>)
</span><span>    </span><span style=color:#f92672;>except</span><span>:
</span><span>        </span><span style=color:#f92672;>return </span><span>[]
</span><span>
</span><span style=font-style:italic;color:#f92672;>def </span><span style=color:#a6e22e;>url_analysis</span><span>(</span><span style=font-style:italic;color:#fd971f;>endpoint</span><span>, </span><span style=font-style:italic;color:#fd971f;>urls</span><span>):
</span><span>    </span><span style=color:#f92672;>for </span><span>url </span><span style=color:#f92672;>in </span><span>urls:
</span><span>        </span><span style=color:#f92672;>if not </span><span>url </span><span style=color:#f92672;>or </span><span>url </span><span style=color:#f92672;>== </span><span style=color:#e6db74;>'#' </span><span style=color:#f92672;>or </span><span style=color:#e6db74;>'javascript' </span><span style=color:#f92672;>in </span><span>url:
</span><span>            </span><span style=color:#f92672;>continue
</span><span>        </span><span style=color:#f92672;>elif </span><span>url.startswith(</span><span style=color:#e6db74;>'/'</span><span>):
</span><span>            </span><span style=color:#f92672;>if </span><span>endpoint.endswith(</span><span style=color:#e6db74;>'/'</span><span>):
</span><span>                endpoint </span><span style=color:#f92672;>= </span><span>endpoint[:</span><span style=color:#f92672;>-</span><span style=color:#ae81ff;>1</span><span>]
</span><span>            </span><span style=color:#f92672;>yield </span><span>endpoint </span><span style=color:#f92672;>+ </span><span>url
</span><span>        </span><span style=color:#f92672;>elif </span><span>url.endswith(</span><span style=color:#e6db74;>'.html'</span><span>) </span><span style=color:#f92672;>or </span><span>url.endswith(</span><span style=color:#e6db74;>'.htm'</span><span>) </span><span style=color:#f92672;>or </span><span>url.endswith(</span><span style=color:#e6db74;>'.shtml'</span><span>) </span><span style=color:#f92672;>or </span><span>url.endswith(</span><span style=color:#e6db74;>'/'</span><span>) </span><span style=color:#f92672;>or </span><span style=color:#e6db74;>'?' </span><span style=color:#f92672;>in </span><span>url:
</span><span>            </span><span style=color:#f92672;>yield </span><span>url
</span><span>
</span><span style=font-style:italic;color:#f92672;>def </span><span style=color:#a6e22e;>path_gene</span><span>(</span><span style=font-style:italic;color:#fd971f;>endpoint</span><span>):
</span><span>    result </span><span style=color:#f92672;>= </span><span>urlparse(endpoint)
</span><span>    </span><span style=color:#f92672;>return </span><span style=font-style:italic;color:#66d9ef;>f</span><span style=color:#e6db74;>'data/</span><span>{</span><span style=color:#e6db74;>"/"</span><span>.join(</span><span style=font-style:italic;color:#66d9ef;>list</span><span>(</span><span style=color:#66d9ef;>filter</span><span>(</span><span style=font-style:italic;color:#f92672;>lambda </span><span style=font-style:italic;color:#fd971f;>x</span><span>:x, result.hostname.split(</span><span style=color:#e6db74;>"."</span><span>)))[::</span><span style=color:#f92672;>-</span><span style=color:#ae81ff;>1</span><span>])}{result.path</span><span style=color:#f92672;>+</span><span style=color:#e6db74;>"/index.html" </span><span style=color:#f92672;>if </span><span>result.path</span><span style=color:#f92672;>!=</span><span style=color:#e6db74;>"/" </span><span style=color:#f92672;>else </span><span style=color:#e6db74;>"/index.html"</span><span>}{result.query.replace(</span><span style=color:#e6db74;>"/"</span><span>,</span><span style=color:#e6db74;>""</span><span>)}</span><span style=color:#e6db74;>'
</span><span>
</span><span style=color:#f92672;>async </span><span style=font-style:italic;color:#f92672;>def </span><span style=color:#a6e22e;>pushurl</span><span>(</span><span style=font-style:italic;color:#fd971f;>url_iter</span><span>, </span><span style=font-style:italic;color:#fd971f;>queue</span><span>):
</span><span>    </span><span style=color:#f92672;>global </span><span>MAX_GET
</span><span>    </span><span style=color:#f92672;>try</span><span>:
</span><span>        </span><span style=color:#f92672;>for </span><span>url </span><span style=color:#f92672;>in </span><span>url_iter:
</span><span>            </span><span style=color:#f92672;>if </span><span>MAX_GET </span><span style=color:#f92672;>> </span><span style=color:#ae81ff;>0</span><span>:
</span><span>                </span><span style=color:#f92672;>await </span><span>queue.put(url)
</span><span>    </span><span style=color:#f92672;>except </span><span style=font-style:italic;color:#66d9ef;>Exception </span><span style=color:#f92672;>as </span><span>e:
</span><span>        </span><span style=color:#f92672;>pass
</span><span>    
</span><span style=color:#f92672;>async </span><span style=font-style:italic;color:#f92672;>def </span><span style=color:#a6e22e;>spider</span><span>(</span><span style=font-style:italic;color:#fd971f;>name</span><span>,</span><span style=font-style:italic;color:#fd971f;>queue</span><span>):
</span><span>    </span><span style=color:#f92672;>global </span><span>MAX_GET, spider_content_set, spider_url_set
</span><span>    </span><span style=color:#f92672;>while </span><span>MAX_GET </span><span style=color:#f92672;>> </span><span style=color:#ae81ff;>0</span><span>:
</span><span>        </span><span style=color:#f92672;>try</span><span>:
</span><span>            endpoint </span><span style=color:#f92672;>= await </span><span>queue.get()
</span><span>            data </span><span style=color:#f92672;>= await </span><span>fetch(endpoint)
</span><span>            md5data </span><span style=color:#f92672;>= </span><span>md5(data.encode()).hexdigest()
</span><span>            </span><span style=color:#f92672;>if </span><span>md5data </span><span style=color:#f92672;>in </span><span>spider_content_set:
</span><span>                status[</span><span style=color:#e6db74;>'same_content'</span><span>] </span><span style=color:#f92672;>+= </span><span style=color:#ae81ff;>1
</span><span>                </span><span style=color:#f92672;>continue
</span><span>            MAX_GET </span><span style=color:#f92672;>-= </span><span style=color:#ae81ff;>1
</span><span>            status[</span><span style=color:#e6db74;>'all'</span><span>] </span><span style=color:#f92672;>+= </span><span style=color:#ae81ff;>1
</span><span>            spider_content_set.add(md5data)
</span><span>            </span><span style=color:#f92672;>await </span><span>savefile(path_gene(endpoint), data)
</span><span>            asyncio.gather(asyncio.create_task(pushurl(url_analysis(endpoint, data_analysis(data)), queue)), </span><span style=font-style:italic;color:#fd971f;>return_exceptions</span><span style=color:#f92672;>=</span><span style=color:#ae81ff;>False</span><span>)
</span><span>            status[</span><span style=color:#e6db74;>'success'</span><span>] </span><span style=color:#f92672;>+= </span><span style=color:#ae81ff;>1
</span><span>        </span><span style=color:#f92672;>except </span><span style=font-style:italic;color:#66d9ef;>Exception </span><span style=color:#f92672;>as </span><span>e:
</span><span>            </span><span style=color:#f92672;>pass
</span><span>
</span><span style=font-style:italic;color:#f92672;>def </span><span style=color:#a6e22e;>exit</span><span>():
</span><span>    </span><span style=color:#66d9ef;>print</span><span>(</span><span style=color:#e6db74;>'exit'</span><span>)
</span><span>    </span><span style=color:#f92672;>for </span><span>task </span><span style=color:#f92672;>in </span><span>asyncio.Task.all_tasks():
</span><span>        task.cancel()
</span><span>    sys.exit(</span><span style=color:#ae81ff;>0</span><span>)
</span><span>
</span><span style=color:#f92672;>async </span><span style=font-style:italic;color:#f92672;>def </span><span style=color:#a6e22e;>main</span><span>(</span><span style=font-style:italic;color:#fd971f;>first_endpoint</span><span>):
</span><span>    queue </span><span style=color:#f92672;>= </span><span>asyncio.Queue(MAX_QUEUE_SIZE)
</span><span>    </span><span style=color:#f92672;>await </span><span>queue.put(first_endpoint)
</span><span>    asyncio.gather(</span><span style=color:#f92672;>*</span><span>[asyncio.create_task(spider(spider_id,queue)) </span><span style=color:#f92672;>for </span><span>spider_id </span><span style=color:#f92672;>in </span><span style=color:#66d9ef;>range</span><span>(MAX_WORKER)], </span><span style=font-style:italic;color:#fd971f;>return_exceptions</span><span style=color:#f92672;>=</span><span style=color:#ae81ff;>False</span><span>)
</span><span>    </span><span style=color:#f92672;>try</span><span>:
</span><span>        </span><span style=color:#f92672;>while </span><span style=color:#ae81ff;>True</span><span>:
</span><span>            </span><span style=color:#f92672;>await </span><span>asyncio.sleep(</span><span style=color:#ae81ff;>1</span><span>)
</span><span>            </span><span style=color:#66d9ef;>print</span><span>(queue.qsize(), MAX_GET, status)
</span><span>            </span><span style=color:#f92672;>if </span><span>MAX_GET </span><span style=color:#f92672;><= </span><span style=color:#ae81ff;>0 </span><span style=color:#f92672;>or not </span><span>queue.qsize():
</span><span>                exit()
</span><span>    </span><span style=color:#f92672;>except</span><span>:
</span><span>        exit()
</span><span>
</span><span style=color:#f92672;>if </span><span>__name__ </span><span style=color:#f92672;>== </span><span style=color:#e6db74;>"__main__"</span><span>:
</span><span>    asyncio.run(main(</span><span style=color:#e6db74;>'https://eindex.me/'</span><span>))
</span><span>    asyncio.get_event_loop().close()
</span></code></pre></section><section class=post-footer><div class=tags><i class="fa-solid fa-tags"></i><span class=tag><a>Python</a></span><span class=tag><a>Crawler</a></span><span class=tag><a>Async</a></span></div></section><section class=comments><script async crossorigin=anonymous data-category-id=DIC_kwDOGWb6Ys4CAKn- data-emit-metadata=0 data-lang=zh-CN data-mapping=pathname data-reactions-enabled=1 data-repo=EINDEX/blog data-repo-id=R_kgDOGWb6Yg data-theme=light src=https://giscus.app/client.js></script></section></article></main><aside></aside></div><footer class=footer><div class=content><div class=item></div><div class=item></div><div class="item profile"><img class=avatar src=/images/avatar.png><ul class=links><li><a href=https://github.com/eindex rel=me target=_blank><i class="fab fa-github"></i><span>Github</span> </a><li><a href=https://twitter.com/eindex_li rel=me target=_blank><i class="fab fa-twitter"></i><span>Twitter</span> </a><li><a href=https://t.me/eindex rel=me target=_blank><i class="fab fa-telegram"></i><span>Telegram</span> </a><li><a href=mailto:eindex.me@outlook.com rel=me target=_blank><i class="fas fa-envelope"></i><span>Email</span> </a></ul></div></div><span class=webring> <a href=https://xn--sr8hvo.ws/%F0%9F%95%90%F0%9F%89%91%F0%9F%88%B6/previous>←</a> An IndieWeb Webring 🕸💍 <a href=https://xn--sr8hvo.ws/%F0%9F%95%90%F0%9F%89%91%F0%9F%88%B6/next>→</a> </span><a class=powered-by href=https://github.com/EINDEX/qingzhuo target=_blank>Powered By QingZhuo </a></footer>