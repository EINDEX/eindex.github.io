<!DOCTYPE html>
<html lang="en" charset="utf-8">
  





<head>
  <link rel="alternate" type="application/rss+xml" title="RSS" href="https://preview.blog-2j7.pages.dev/feed.xml">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="author" itemprop="author" content="EINDEX">
  
  <title>一百行代码实现异步爬虫 &bull; EINDEX&#x27;s Blog</title>
  <meta property="og:title" content="一百行代码实现异步爬虫 &bull; EINDEX&#x27;s Blog" />
  

  <!-- Required meta tags -->
  <meta charset="utf-8" />


  <!-- **** BEGINNING, favicons **** -->

  <!-- generics -->

  <!-- iOS -->

  <!-- Android -->

  <!-- Windows 8, IE 10 -->

  <!-- Windows 8.1 and up, IE 11 -->

  <!-- **** CONCLUSION, favicons **** -->

  <!-- CSS/SCSS -->
  <link rel="stylesheet" href="https://preview.blog-2j7.pages.dev/css/index.css?h=f8faf511a8be60c25ce46e10d43e25cc133e48203f3dc383262447b1abda9301" />  <style>@-moz-document url-prefix() {.lazy:-moz-loading {visibility:hidden;}}.ieOnly {display: none;}@media all and (-ms-high-contrast: none), (-ms-high-contrast: active) {.ieOnly {display: block;}}</style>
  
  <link rel="stylesheet" href="https://preview.blog-2j7.pages.dev/styles/fontawesome.min.css?h=7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f">

  <link rel="webmention" href="https://webmention.io/eindex.me/webmention" />
  <link rel="pingback" href="https://webmention.io/eindex.me/xmlrpc" />
  
  
  
  <link rel="apple-touch-icon" sizes="512x512" href="/favicon-512.png">
  
  <link rel="icon" type="image/png" sizes="512x512" href="/favicon-512.png">
  
  
  <link rel="icon" type="image/png" sizes="192x192" href="/favicon-192.png">
  
  <link rel="manifest" href="/manifest.json">

  



  
    
  

  
    
  
    
  
    
  





<meta property="og:url" content="https://preview.blog-2j7.pages.dev/posts/one-hundred-line-async-crawler/">
<meta property="og:site_name" content="EINDEX&#x27;s Blog">
<meta property="og:image" content="https://preview.blog-2j7.pages.dev/images/avatar.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="一百行代码实现异步爬虫 &bull; EINDEX&#x27;s Blog">

<meta name="twitter:site" content="@eindex_li">
<meta name="twitter:creator" content="@eindex_li">
<meta name="twitter:image" content="https://preview.blog-2j7.pages.dev/images/avatar.png">

<script type="application/ld+json">
    {
      "@context": "https://schema.org/",
      "@type": "BlogPosting",
      "headline": "一百行代码实现异步爬虫",
      "image": "https://preview.blog-2j7.pages.dev/images/avatar.png",
      
      "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://preview.blog-2j7.pages.dev/posts/one-hundred-line-async-crawler/"
      },
      
      "datePublished": "2019-09-07",
      
      
      "author": {
        "@type": "Person",
        "name": "EINDEX",
        "url": "https://preview.blog-2j7.pages.dev/about"
      },
      "publisher": {
        "@type": "Organization",
        "name": "EINDEX's Blog",
        "logo": {
          "@type": "ImageObject",
          "url": "https://preview.blog-2j7.pages.dev/images/avatar.png"
      },
      "keywords": ["代码","Python","Crawler","Async"]
    }
</script>

  
  
  
</head>
  <body>
    <nav class="navbar">
    <ul class="items">
      <li>
        
        <a class="site-link" href="https:&#x2F;&#x2F;preview.blog-2j7.pages.dev&#x2F;"><img
            class="avatar"
            src="https:&#x2F;&#x2F;preview.blog-2j7.pages.dev&#x2F;processed_images&#x2F;985d495e6e585ad000.png"
            alt="Workflow"
        /><span class="site-name">EINDEX&#x27;s Blog</span></a>
      </li>
      <li class="delimiter"></li>
      
      <li class="button">
        <a
          href="https://preview.blog-2j7.pages.dev/archive/"
          >归档</a
        >
      </li>
      
      <li class="button">
        <a
          href="https://preview.blog-2j7.pages.dev/links/"
          >友链</a
        >
      </li>
      
      <li class="button">
        <a
          href="https://preview.blog-2j7.pages.dev/about/"
          >关于</a
        >
      </li>
      
    </ul>
</nav>


    <div class="content">
        <main>
            
  <article data-clarity-region="article">
    
<section class="header">
<section class="title-area">
    
    <h1 class="title">  
    <a href="https:&#x2F;&#x2F;preview.blog-2j7.pages.dev&#x2F;posts&#x2F;one-hundred-line-async-crawler&#x2F;">一百行代码实现异步爬虫</a>
    </h1>
  </section>
  <section class="meta-area">
  
    <span><i class="far fa-calendar-days"></i><time>2019-09-07</time></span>
  
  
    
    
    <a class="categories"  href="https:&#x2F;&#x2F;preview.blog-2j7.pages.dev&#x2F;categories&#x2F;dai-ma&#x2F;"><i class="fa-solid fa-inbox"></i>代码</a>
  
    <span><i class="fas fa-clock"></i> 3 mins</span>
  </section>
</section>

    <section class="main">
        
        <p>一个优雅的爬虫需要一下这些东西：</p>
<ul>
<li>请求器</li>
<li>页面解析器</li>
<li>链接生成器</li>
<li>调度器</li>
</ul>
<span id="continue-reading"></span><h2 id="请求器">请求器</h2>
<p>负责发送请求。</p>
<h2 id="页面解析器">页面解析器</h2>
<p>负责从页面上解析出继续爬的链接。</p>
<h2 id="链接生成器">链接生成器</h2>
<p>负责处理继续爬虫的链接并放入队列。</p>
<h2 id="调度器">调度器</h2>
<p>决定链接是否应该被爬去的核心部件。</p>
<h2 id="异步">异步</h2>
<p>同时有多个请求在发送，即时异步爬虫。</p>
<h2 id="代码">代码</h2>
<p>相关代码已上传到 <a href="https://github.com/EINDEX/100-line-async-spider">Github[https://github.com/EINDEX/100-line-async-spider]</a>。</p>
<pre data-lang="python" style="background-color:#272822;color:#f8f8f2;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#f92672;">import </span><span>aiohttp, asyncio, aiofiles, lxml, pathlib, sys, re, lxml.html
</span><span style="color:#f92672;">from </span><span>urllib.parse </span><span style="color:#f92672;">import </span><span>urlparse
</span><span style="color:#f92672;">from </span><span>pathlib </span><span style="color:#f92672;">import </span><span>Path
</span><span style="color:#f92672;">from </span><span>hashlib </span><span style="color:#f92672;">import </span><span>md5
</span><span>
</span><span>MAX_GET, MAX_QUEUE_SIZE, MAX_WORKER </span><span style="color:#f92672;">= </span><span style="color:#ae81ff;">10000</span><span>, </span><span style="color:#ae81ff;">100</span><span>, </span><span style="color:#ae81ff;">20
</span><span>spider_url_set, spider_content_set </span><span style="color:#f92672;">= </span><span style="font-style:italic;color:#66d9ef;">set</span><span>(), </span><span style="font-style:italic;color:#66d9ef;">set</span><span>()
</span><span>status </span><span style="color:#f92672;">= </span><span>{</span><span style="color:#e6db74;">&quot;success&quot;</span><span>: </span><span style="color:#ae81ff;">0</span><span>, </span><span style="color:#e6db74;">&quot;all&quot;</span><span>: </span><span style="color:#ae81ff;">0</span><span>, </span><span style="color:#e6db74;">&quot;same&quot;</span><span>: </span><span style="color:#ae81ff;">0</span><span>, </span><span style="color:#e6db74;">&quot;same_content&quot;</span><span>:</span><span style="color:#ae81ff;">0</span><span>}
</span><span>
</span><span style="color:#f92672;">async </span><span style="font-style:italic;color:#f92672;">def </span><span style="color:#a6e22e;">fetch</span><span>(</span><span style="font-style:italic;color:#fd971f;">url</span><span>):
</span><span>    </span><span style="color:#f92672;">global </span><span>MAX_GET
</span><span>    </span><span style="color:#f92672;">if </span><span>MAX_GET </span><span style="color:#f92672;">&lt; </span><span style="color:#ae81ff;">0</span><span>:
</span><span>        </span><span style="color:#f92672;">return
</span><span>    </span><span style="color:#f92672;">async with </span><span>aiohttp.ClientSession(</span><span style="font-style:italic;color:#fd971f;">connector</span><span style="color:#f92672;">=</span><span>aiohttp.TCPConnector(</span><span style="font-style:italic;color:#fd971f;">ssl</span><span style="color:#f92672;">=</span><span style="color:#ae81ff;">False</span><span>), </span><span style="font-style:italic;color:#fd971f;">timeout</span><span style="color:#f92672;">=</span><span>aiohttp.ClientTimeout(</span><span style="font-style:italic;color:#fd971f;">total</span><span style="color:#f92672;">=</span><span style="color:#ae81ff;">1</span><span>)) </span><span style="color:#f92672;">as </span><span>session:
</span><span>        </span><span style="color:#f92672;">async with </span><span>session.get(url) </span><span style="color:#f92672;">as </span><span>response:
</span><span>            </span><span style="color:#f92672;">return await </span><span>response.text()
</span><span>
</span><span style="color:#f92672;">async </span><span style="font-style:italic;color:#f92672;">def </span><span style="color:#a6e22e;">savefile</span><span>(</span><span style="font-style:italic;color:#fd971f;">path</span><span>, </span><span style="font-style:italic;color:#fd971f;">data</span><span>):
</span><span>    path </span><span style="color:#f92672;">= </span><span>Path(path)
</span><span>    path.parent.mkdir(</span><span style="font-style:italic;color:#fd971f;">parents</span><span style="color:#f92672;">=</span><span style="color:#ae81ff;">True</span><span>, </span><span style="font-style:italic;color:#fd971f;">exist_ok</span><span style="color:#f92672;">=</span><span style="color:#ae81ff;">True</span><span>)
</span><span>    </span><span style="color:#f92672;">async with </span><span>aiofiles.open(path, </span><span style="font-style:italic;color:#fd971f;">mode</span><span style="color:#f92672;">=</span><span style="color:#e6db74;">&#39;w&#39;</span><span>) </span><span style="color:#f92672;">as </span><span>f:
</span><span>        </span><span style="color:#f92672;">await </span><span>f.write(data)
</span><span>
</span><span style="font-style:italic;color:#f92672;">def </span><span style="color:#a6e22e;">data_analysis</span><span>(</span><span style="font-style:italic;color:#fd971f;">data</span><span>):
</span><span>    </span><span style="color:#f92672;">try</span><span>:
</span><span>        html </span><span style="color:#f92672;">= </span><span>lxml.html.fromstring(data)
</span><span>        </span><span style="color:#f92672;">return </span><span>html.xpath(</span><span style="color:#e6db74;">&#39;//a/@href&#39;</span><span>)
</span><span>    </span><span style="color:#f92672;">except</span><span>:
</span><span>        </span><span style="color:#f92672;">return </span><span>[]
</span><span>
</span><span style="font-style:italic;color:#f92672;">def </span><span style="color:#a6e22e;">url_analysis</span><span>(</span><span style="font-style:italic;color:#fd971f;">endpoint</span><span>, </span><span style="font-style:italic;color:#fd971f;">urls</span><span>):
</span><span>    </span><span style="color:#f92672;">for </span><span>url </span><span style="color:#f92672;">in </span><span>urls:
</span><span>        </span><span style="color:#f92672;">if not </span><span>url </span><span style="color:#f92672;">or </span><span>url </span><span style="color:#f92672;">== </span><span style="color:#e6db74;">&#39;#&#39; </span><span style="color:#f92672;">or </span><span style="color:#e6db74;">&#39;javascript&#39; </span><span style="color:#f92672;">in </span><span>url:
</span><span>            </span><span style="color:#f92672;">continue
</span><span>        </span><span style="color:#f92672;">elif </span><span>url.startswith(</span><span style="color:#e6db74;">&#39;/&#39;</span><span>):
</span><span>            </span><span style="color:#f92672;">if </span><span>endpoint.endswith(</span><span style="color:#e6db74;">&#39;/&#39;</span><span>):
</span><span>                endpoint </span><span style="color:#f92672;">= </span><span>endpoint[:</span><span style="color:#f92672;">-</span><span style="color:#ae81ff;">1</span><span>]
</span><span>            </span><span style="color:#f92672;">yield </span><span>endpoint </span><span style="color:#f92672;">+ </span><span>url
</span><span>        </span><span style="color:#f92672;">elif </span><span>url.endswith(</span><span style="color:#e6db74;">&#39;.html&#39;</span><span>) </span><span style="color:#f92672;">or </span><span>url.endswith(</span><span style="color:#e6db74;">&#39;.htm&#39;</span><span>) </span><span style="color:#f92672;">or </span><span>url.endswith(</span><span style="color:#e6db74;">&#39;.shtml&#39;</span><span>) </span><span style="color:#f92672;">or </span><span>url.endswith(</span><span style="color:#e6db74;">&#39;/&#39;</span><span>) </span><span style="color:#f92672;">or </span><span style="color:#e6db74;">&#39;?&#39; </span><span style="color:#f92672;">in </span><span>url:
</span><span>            </span><span style="color:#f92672;">yield </span><span>url
</span><span>
</span><span style="font-style:italic;color:#f92672;">def </span><span style="color:#a6e22e;">path_gene</span><span>(</span><span style="font-style:italic;color:#fd971f;">endpoint</span><span>):
</span><span>    result </span><span style="color:#f92672;">= </span><span>urlparse(endpoint)
</span><span>    </span><span style="color:#f92672;">return </span><span style="font-style:italic;color:#66d9ef;">f</span><span style="color:#e6db74;">&#39;data/</span><span>{</span><span style="color:#e6db74;">&quot;/&quot;</span><span>.join(</span><span style="font-style:italic;color:#66d9ef;">list</span><span>(</span><span style="color:#66d9ef;">filter</span><span>(</span><span style="font-style:italic;color:#f92672;">lambda </span><span style="font-style:italic;color:#fd971f;">x</span><span>:x, result.hostname.split(</span><span style="color:#e6db74;">&quot;.&quot;</span><span>)))[::</span><span style="color:#f92672;">-</span><span style="color:#ae81ff;">1</span><span>])}{result.path</span><span style="color:#f92672;">+</span><span style="color:#e6db74;">&quot;/index.html&quot; </span><span style="color:#f92672;">if </span><span>result.path</span><span style="color:#f92672;">!=</span><span style="color:#e6db74;">&quot;/&quot; </span><span style="color:#f92672;">else </span><span style="color:#e6db74;">&quot;/index.html&quot;</span><span>}{result.query.replace(</span><span style="color:#e6db74;">&quot;/&quot;</span><span>,</span><span style="color:#e6db74;">&quot;&quot;</span><span>)}</span><span style="color:#e6db74;">&#39;
</span><span>
</span><span style="color:#f92672;">async </span><span style="font-style:italic;color:#f92672;">def </span><span style="color:#a6e22e;">pushurl</span><span>(</span><span style="font-style:italic;color:#fd971f;">url_iter</span><span>, </span><span style="font-style:italic;color:#fd971f;">queue</span><span>):
</span><span>    </span><span style="color:#f92672;">global </span><span>MAX_GET
</span><span>    </span><span style="color:#f92672;">try</span><span>:
</span><span>        </span><span style="color:#f92672;">for </span><span>url </span><span style="color:#f92672;">in </span><span>url_iter:
</span><span>            </span><span style="color:#f92672;">if </span><span>MAX_GET </span><span style="color:#f92672;">&gt; </span><span style="color:#ae81ff;">0</span><span>:
</span><span>                </span><span style="color:#f92672;">await </span><span>queue.put(url)
</span><span>    </span><span style="color:#f92672;">except </span><span style="font-style:italic;color:#66d9ef;">Exception </span><span style="color:#f92672;">as </span><span>e:
</span><span>        </span><span style="color:#f92672;">pass
</span><span>    
</span><span style="color:#f92672;">async </span><span style="font-style:italic;color:#f92672;">def </span><span style="color:#a6e22e;">spider</span><span>(</span><span style="font-style:italic;color:#fd971f;">name</span><span>,</span><span style="font-style:italic;color:#fd971f;">queue</span><span>):
</span><span>    </span><span style="color:#f92672;">global </span><span>MAX_GET, spider_content_set, spider_url_set
</span><span>    </span><span style="color:#f92672;">while </span><span>MAX_GET </span><span style="color:#f92672;">&gt; </span><span style="color:#ae81ff;">0</span><span>:
</span><span>        </span><span style="color:#f92672;">try</span><span>:
</span><span>            endpoint </span><span style="color:#f92672;">= await </span><span>queue.get()
</span><span>            data </span><span style="color:#f92672;">= await </span><span>fetch(endpoint)
</span><span>            md5data </span><span style="color:#f92672;">= </span><span>md5(data.encode()).hexdigest()
</span><span>            </span><span style="color:#f92672;">if </span><span>md5data </span><span style="color:#f92672;">in </span><span>spider_content_set:
</span><span>                status[</span><span style="color:#e6db74;">&#39;same_content&#39;</span><span>] </span><span style="color:#f92672;">+= </span><span style="color:#ae81ff;">1
</span><span>                </span><span style="color:#f92672;">continue
</span><span>            MAX_GET </span><span style="color:#f92672;">-= </span><span style="color:#ae81ff;">1
</span><span>            status[</span><span style="color:#e6db74;">&#39;all&#39;</span><span>] </span><span style="color:#f92672;">+= </span><span style="color:#ae81ff;">1
</span><span>            spider_content_set.add(md5data)
</span><span>            </span><span style="color:#f92672;">await </span><span>savefile(path_gene(endpoint), data)
</span><span>            asyncio.gather(asyncio.create_task(pushurl(url_analysis(endpoint, data_analysis(data)), queue)), </span><span style="font-style:italic;color:#fd971f;">return_exceptions</span><span style="color:#f92672;">=</span><span style="color:#ae81ff;">False</span><span>)
</span><span>            status[</span><span style="color:#e6db74;">&#39;success&#39;</span><span>] </span><span style="color:#f92672;">+= </span><span style="color:#ae81ff;">1
</span><span>        </span><span style="color:#f92672;">except </span><span style="font-style:italic;color:#66d9ef;">Exception </span><span style="color:#f92672;">as </span><span>e:
</span><span>            </span><span style="color:#f92672;">pass
</span><span>
</span><span style="font-style:italic;color:#f92672;">def </span><span style="color:#a6e22e;">exit</span><span>():
</span><span>    </span><span style="color:#66d9ef;">print</span><span>(</span><span style="color:#e6db74;">&#39;exit&#39;</span><span>)
</span><span>    </span><span style="color:#f92672;">for </span><span>task </span><span style="color:#f92672;">in </span><span>asyncio.Task.all_tasks():
</span><span>        task.cancel()
</span><span>    sys.exit(</span><span style="color:#ae81ff;">0</span><span>)
</span><span>
</span><span style="color:#f92672;">async </span><span style="font-style:italic;color:#f92672;">def </span><span style="color:#a6e22e;">main</span><span>(</span><span style="font-style:italic;color:#fd971f;">first_endpoint</span><span>):
</span><span>    queue </span><span style="color:#f92672;">= </span><span>asyncio.Queue(MAX_QUEUE_SIZE)
</span><span>    </span><span style="color:#f92672;">await </span><span>queue.put(first_endpoint)
</span><span>    asyncio.gather(</span><span style="color:#f92672;">*</span><span>[asyncio.create_task(spider(spider_id,queue)) </span><span style="color:#f92672;">for </span><span>spider_id </span><span style="color:#f92672;">in </span><span style="color:#66d9ef;">range</span><span>(MAX_WORKER)], </span><span style="font-style:italic;color:#fd971f;">return_exceptions</span><span style="color:#f92672;">=</span><span style="color:#ae81ff;">False</span><span>)
</span><span>    </span><span style="color:#f92672;">try</span><span>:
</span><span>        </span><span style="color:#f92672;">while </span><span style="color:#ae81ff;">True</span><span>:
</span><span>            </span><span style="color:#f92672;">await </span><span>asyncio.sleep(</span><span style="color:#ae81ff;">1</span><span>)
</span><span>            </span><span style="color:#66d9ef;">print</span><span>(queue.qsize(), MAX_GET, status)
</span><span>            </span><span style="color:#f92672;">if </span><span>MAX_GET </span><span style="color:#f92672;">&lt;= </span><span style="color:#ae81ff;">0 </span><span style="color:#f92672;">or not </span><span>queue.qsize():
</span><span>                exit()
</span><span>    </span><span style="color:#f92672;">except</span><span>:
</span><span>        exit()
</span><span>
</span><span style="color:#f92672;">if </span><span>__name__ </span><span style="color:#f92672;">== </span><span style="color:#e6db74;">&quot;__main__&quot;</span><span>:
</span><span>    asyncio.run(main(</span><span style="color:#e6db74;">&#39;https://eindex.me/&#39;</span><span>))
</span><span>    asyncio.get_event_loop().close()
</span></code></pre>

    </section>
    <section class="post-footer">
        
        
<div class="tags">
    <i class="fa-solid fa-tags"></i>
    
        <span class="tag"><a href="">Python</a></span>
    
        <span class="tag"><a href="">Crawler</a></span>
    
        <span class="tag"><a href="">Async</a></span>
    
</div>

    </section>
    
    <section class="comments">
        
<script src="https://giscus.app/client.js"
    data-repo="EINDEX&#x2F;blog"
    data-repo-id="R_kgDOGWb6Yg"
    data-category-id="DIC_kwDOGWb6Ys4CAKn-"
    data-mapping="pathname"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-theme="light"
    data-lang="zh-CN"
    crossorigin="anonymous"
    async>
</script>

    </section>
    
</article>


        </main>
        <aside>
            
        </aside>
    </div>
    <footer class="footer">
  <div class="content">
    <div class="item">
    </div>
    <div class="item"></div>
    <div class="item profile">
      <img class="avatar" src="/images/avatar.png" />
      <ul class="links">
        
        <li>
          <a href="https:&#x2F;&#x2F;github.com&#x2F;eindex" rel="me" target="_blank"
            ><i class="fab fa-github"></i><span>Github</span>
          </a>
        </li>
        
        <li>
          <a href="https:&#x2F;&#x2F;twitter.com&#x2F;eindex_li" rel="me" target="_blank"
            ><i class="fab fa-twitter"></i><span>Twitter</span>
          </a>
        </li>
        
        <li>
          <a href="https:&#x2F;&#x2F;t.me&#x2F;eindex" rel="me" target="_blank"
            ><i class="fab fa-telegram"></i><span>Telegram</span>
          </a>
        </li>
        
        <li>
          <a href="mailto:eindex.me@outlook.com" rel="me" target="_blank"
            ><i class="fas fa-envelope"></i><span>Email</span>
          </a>
        </li>
        
      </ul>
    </div>
  </div>
  
  
    
    
  
  <span class="webring">
<a href="https://xn--sr8hvo.ws/%F0%9F%95%90%F0%9F%89%91%F0%9F%88%B6/previous">←</a>
An IndieWeb Webring 🕸💍
<a href="https://xn--sr8hvo.ws/%F0%9F%95%90%F0%9F%89%91%F0%9F%88%B6/next">→</a>
</span>
  <a
    class="powered-by"
    href="https://github.com/EINDEX/qingzhuo"
    target="_blank"
    >Powered By QingZhuo
  </a>
  
</footer>

  </body>
  
</html>